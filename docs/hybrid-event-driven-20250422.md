# 🔄 混合事件驱动架构说明  
📄 文档名称：hybrid-event-driven-20250422.md  
🗓️ 更新时间：2025-04-22  

---

## 📦 架构背景

iN 项目为异步图像处理系统，流程包括：
- 下载图片 → 元数据提取 → AI 分析 → 存储 → 查询展示

其中需要：
- 主链控制流程一致性
- 副作用任务（如日志、索引）异步解耦

---

## 🎯 架构原则

> 主链使用 Task Queue + DO 控制严格流程  
> 旁路副作用使用 Event Queue 发布广播 → 订阅者异步消费

---

## 🧱 实际实现结构

| 层级 | 机制 | 描述 |
|------|------|------|
| 主任务流程 | Queue + Durable Object | 状态机控制下载 → 元数据 → AI |
| 事件发布 | Worker 内部发出事件（如 `image.downloaded`） | 使用 `INEvent<T>` 结构 |
| 事件订阅 | 可选 Worker 订阅事件队列（如 `log-worker`） | 实现异步副作用 |
| 事件接口 | `shared-libs/events/` | 所有事件统一定义结构 |
| 幂等与重试 | 所有消费者实现幂等处理 | 支持重复交付、支持 DLQ |

---

## 🧩 插件系统简化说明

- 插件 Worker 仅为示范用途：如 `log-enhancer-worker`
- 插件不具备注册中心、生命周期感知
- 插件发布仅通过 `INEvent<T>` 广播机制触发

---

## 📘 总结

主链可控、副作用可插、整体异步、可观测，是现代事件架构实践的简化落地方案。
