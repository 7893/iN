## æ··åˆäº‹ä»¶é©±åŠ¨æ¶æ„ (Hybrid Event-Driven Architecture)

ğŸ¯ **ç›®çš„:** è§£é‡Šæœ¬é¡¹ç›®é‡‡ç”¨â€œä»»åŠ¡é˜Ÿåˆ— + äº‹ä»¶é˜Ÿåˆ—â€æ··åˆæ¨¡å¼çš„åŸå› ï¼Œå®šä¹‰äº‹ä»¶çš„æ ‡å‡†åŒ–ç»“æ„ã€ä¸åŒé˜Ÿåˆ—çš„ç”¨é€”ä»¥åŠäº‹ä»¶çš„å‘½åè§„èŒƒã€‚

### ä¸ºä»€ä¹ˆé‡‡ç”¨ä»»åŠ¡ + äº‹ä»¶æ··åˆæ¨¡å¼ï¼Ÿ

çº¯ç²¹çš„äº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆæ‰€æœ‰äº¤äº’é€šè¿‡äº‹ä»¶è§£è€¦ï¼‰æä¾›äº†æé«˜çš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ï¼Œä½†å¯èƒ½å¯¼è‡´ç«¯åˆ°ç«¯ä¸šåŠ¡æµç¨‹éš¾ä»¥è¿½è¸ªã€åˆ†å¸ƒå¼è°ƒè¯•å¤æ‚ã€æœ€ç»ˆä¸€è‡´æ€§ç®¡ç†å›°éš¾ã€‚è€Œçº¯ç²¹çš„ä»»åŠ¡é˜Ÿåˆ—é©±åŠ¨åˆ™ç¼ºä¹å¹¿æ’­èƒ½åŠ›ï¼Œéš¾ä»¥çµæ´»åœ°å¢åŠ å¯¹æµç¨‹ä¸­æŸäº›çŠ¶æ€å˜æ›´æ„Ÿå…´è¶£çš„â€œå‰¯ä½œç”¨â€å¤„ç†é€»è¾‘ï¼ˆå¦‚é€šçŸ¥ã€ç»Ÿè®¡ã€ç´¢å¼•ç­‰ï¼‰ã€‚

æœ¬é¡¹ç›®é‡‡ç”¨**æ··åˆæ¨¡å¼**æ—¨åœ¨ç»“åˆä¸¤è€…çš„ä¼˜ç‚¹ï¼š

1.  **æ ¸å¿ƒæµç¨‹æ¸…æ™°å¯æ§:** å¯¹äºå›¾ç‰‡å¤„ç†è¿™ç§å…·æœ‰æ˜ç¡®å…ˆåé¡ºåºçš„æ ¸å¿ƒä¸šåŠ¡æµç¨‹ï¼ˆä¸‹è½½ -> å…ƒæ•°æ® -> AIï¼‰ï¼Œæˆ‘ä»¬ç»§ç»­ä½¿ç”¨**ä»»åŠ¡é˜Ÿåˆ— (Task Queues)** æ¥é©±åŠ¨ã€‚è¿™ä½¿å¾—ä¸»æµç¨‹çš„çŠ¶æ€å¯ä»¥é€šè¿‡ `Task Coordinator DO` æ¸…æ™°åœ°è·Ÿè¸ªï¼Œä¾¿äºç®¡ç†å’Œç†è§£ã€‚
2.  **å‰¯ä½œç”¨çµæ´»è§£è€¦:** å¯¹äºæ ¸å¿ƒæµç¨‹ä¸­äº§ç”Ÿçš„å…³é”®**é‡Œç¨‹ç¢‘äº‹ä»¶**ï¼ˆå¦‚â€œå›¾ç‰‡ä¸‹è½½å®Œæˆâ€ã€â€œä»»åŠ¡å¤„ç†æˆåŠŸ/å¤±è´¥â€ï¼‰æˆ–ç³»ç»Ÿä¸­å…¶ä»–å¯èƒ½è¢«å¤šä¸ªç‹¬ç«‹æ¨¡å—å…³æ³¨çš„çŠ¶æ€å˜åŒ–ï¼Œæˆ‘ä»¬ä½¿ç”¨**äº‹ä»¶é˜Ÿåˆ— (Event Queues)** æ¥è¿›è¡Œå¹¿æ’­ã€‚è¿™æ ·ï¼Œæ·»åŠ æ–°çš„å“åº”é€»è¾‘ï¼ˆå¦‚å‘é€é€šçŸ¥ã€æ›´æ–°ç»Ÿè®¡ã€è§¦å‘ç‰¹å®šæ’ä»¶ï¼‰æ—¶ï¼Œåªéœ€è®©æ–°çš„ Worker è®¢é˜…ç›¸åº”çš„äº‹ä»¶é˜Ÿåˆ—å³å¯ï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒæµç¨‹ä»£ç ï¼Œå®ç°äº†é«˜åº¦è§£è€¦å’Œæ‰©å±•æ€§ã€‚
3.  **å¹³è¡¡å¤æ‚åº¦:** è¿™ç§æ–¹å¼é¿å…äº†æ‰€æœ‰äº¤äº’éƒ½ä¾èµ–äº‹ä»¶å¯èƒ½å¸¦æ¥çš„è¿‡åº¦å¤æ‚æ€§ï¼Œå°†å¤æ‚æ€§æ§åˆ¶åœ¨éœ€è¦çµæ´»æ‰©å±•çš„â€œå‰¯ä½œç”¨â€å¤„ç†ä¸Šï¼Œè€Œæ ¸å¿ƒæµç¨‹ä¿æŒç›¸å¯¹ç®€å•ç›´æ¥ã€‚

### é˜Ÿåˆ—ç”¨é€”å®šä¹‰

- **ä»»åŠ¡é˜Ÿåˆ— (Task Queues):**
  - **ç”¨é€”:** ä¼ é€’**æŒ‡ä»¤æ€§**æ¶ˆæ¯ï¼Œé©±åŠ¨æ ¸å¿ƒä¸šåŠ¡æµç¨‹æŒ‰é¢„å®šé¡ºåºæ‰§è¡Œä¸‹ä¸€æ­¥ã€‚
  - **ç¤ºä¾‹:** `ImageDownloadQueue`, `MetadataProcessingQueue`, `AIProcessingQueue`
  - **æ¶ˆè´¹è€…:** é€šå¸¸æ˜¯**å•ä¸€ç±»å‹**çš„ Workerï¼Œè´Ÿè´£æ‰§è¡Œè¯¥ä»»åŠ¡æŒ‡ä»¤ã€‚
  - **çŠ¶æ€å…³è”:** å¤„ç† Task Queue çš„ Worker é€šå¸¸è´Ÿè´£æ›´æ–° `Task Coordinator DO` ä¸­å¯¹åº”çš„ä»»åŠ¡**ä¸»æµç¨‹çŠ¶æ€**ã€‚

- **äº‹ä»¶é˜Ÿåˆ— (Event Queues):**
  - **ç”¨é€”:** å¹¿æ’­**äº‹å®æ€§**æ¶ˆæ¯ï¼Œé€šçŸ¥ç³»ç»Ÿä¸­å‘ç”Ÿäº†æŸä¸ªé‡è¦çš„é‡Œç¨‹ç¢‘äº‹ä»¶æˆ–çŠ¶æ€å˜æ›´ã€‚
  - **ç¤ºä¾‹:** `ImageEventsQueue`, `TaskLifecycleEventsQueue`
  - **æ¶ˆè´¹è€…:** å¯ä»¥æ˜¯**å¤šç§ä¸åŒç±»å‹**çš„ Workerï¼ˆé€šçŸ¥ã€ç»Ÿè®¡ã€ç´¢å¼•ã€æ’ä»¶ç­‰ï¼‰ï¼Œå®ƒä»¬å„è‡ªç‹¬ç«‹åœ°å¯¹æ„Ÿå…´è¶£çš„äº‹ä»¶åšå‡ºå“åº”ã€‚
  - **çŠ¶æ€å…³è”:** è®¢é˜… Event Queue çš„ Worker **é€šå¸¸ä¸**æ›´æ–° `Task Coordinator DO` çš„ä¸»æµç¨‹çŠ¶æ€ï¼Œå®ƒä»¬å¤„ç†çš„æ˜¯ç‹¬ç«‹çš„å‰¯ä½œç”¨é€»è¾‘ã€‚äº‹ä»¶æµçš„è¿½è¸ªä¸»è¦ä¾èµ–æ—¥å¿—å’Œ `traceId`ã€‚

### å‘å¸ƒäº‹ä»¶çš„æ—¶æœº (ç¤ºä¾‹)

- `DownloadWorker` å®Œæˆå›¾ç‰‡ä¸‹è½½ -> å‘å¸ƒ `image.downloaded`
- `MetadataWorker` æå–å…ƒæ•°æ® -> å‘å¸ƒ `image.metadata_extracted`
- `AIWorker` ç”Ÿæˆå‘é‡åŒ–åˆ†æ -> å‘å¸ƒ `image.analyzed`
- æœ€åå®Œæˆä»»åŠ¡ -> å‘å¸ƒ `task.completed`
- ä»»æ„å¤±è´¥ -> å‘å¸ƒ `task.failed`

### äº‹ä»¶ç»“æ„çº¦å®š

```ts
export interface INEvent<T = Record<string, any>> {
  eventId: string;
  eventType: string;
  taskId?: string;
  traceId: string;
  timestamp: number;
  source: string;
  payload: T;
}
