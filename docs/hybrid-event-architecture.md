## æ··åˆäº‹ä»¶é©±åŠ¨æ¶æ„ (Hybrid Event-Driven Architecture)

ğŸ¯ **ç›®çš„:** è§£é‡Šæœ¬é¡¹ç›®é‡‡ç”¨â€œä»»åŠ¡é˜Ÿåˆ— + äº‹ä»¶é˜Ÿåˆ—â€æ··åˆæ¨¡å¼çš„åŸå› ï¼Œå®šä¹‰äº‹ä»¶çš„æ ‡å‡†åŒ–ç»“æ„ã€ä¸åŒé˜Ÿåˆ—çš„ç”¨é€”ä»¥åŠäº‹ä»¶çš„å‘½åè§„èŒƒã€‚

---

### ä¸ºä»€ä¹ˆé‡‡ç”¨ä»»åŠ¡ + äº‹ä»¶æ··åˆæ¨¡å¼ï¼Ÿ

çº¯ç²¹çš„äº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆæ‰€æœ‰äº¤äº’é€šè¿‡äº‹ä»¶è§£è€¦ï¼‰æä¾›äº†æé«˜çš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ï¼Œä½†å¯èƒ½å¯¼è‡´ç«¯åˆ°ç«¯ä¸šåŠ¡æµç¨‹éš¾ä»¥è¿½è¸ªã€åˆ†å¸ƒå¼è°ƒè¯•å¤æ‚ã€æœ€ç»ˆä¸€è‡´æ€§ç®¡ç†å›°éš¾ã€‚è€Œçº¯ç²¹çš„ä»»åŠ¡é˜Ÿåˆ—é©±åŠ¨åˆ™ç¼ºä¹å¹¿æ’­èƒ½åŠ›ï¼Œéš¾ä»¥çµæ´»åœ°å¢åŠ å¯¹æµç¨‹ä¸­æŸäº›çŠ¶æ€å˜æ›´æ„Ÿå…´è¶£çš„â€œå‰¯ä½œç”¨â€å¤„ç†é€»è¾‘ï¼ˆå¦‚é€šçŸ¥ã€ç»Ÿè®¡ã€ç´¢å¼•ç­‰ï¼‰ã€‚

æœ¬é¡¹ç›®é‡‡ç”¨**æ··åˆæ¨¡å¼**æ—¨åœ¨ç»“åˆä¸¤è€…çš„ä¼˜ç‚¹ï¼š

1. **æ ¸å¿ƒæµç¨‹æ¸…æ™°å¯æ§:**  
   å¯¹äºå›¾ç‰‡å¤„ç†è¿™ç§å…·æœ‰æ˜ç¡®å…ˆåé¡ºåºçš„æ ¸å¿ƒä¸šåŠ¡æµç¨‹ï¼ˆä¸‹è½½ â†’ å…ƒæ•°æ® â†’ AIï¼‰ï¼Œæˆ‘ä»¬ç»§ç»­ä½¿ç”¨ **ä»»åŠ¡é˜Ÿåˆ— (Task Queues)** æ¥é©±åŠ¨ï¼Œä¾¿äºçŠ¶æ€ç®¡ç†ä¸è°ƒè¯•ã€‚

2. **å‰¯ä½œç”¨çµæ´»è§£è€¦:**  
   å¯¹äºæµç¨‹ä¸­äº§ç”Ÿçš„å…³é”®**é‡Œç¨‹ç¢‘äº‹ä»¶**ï¼ˆå¦‚å›¾ç‰‡ä¸‹è½½å®Œæˆã€ä»»åŠ¡å®Œæˆç­‰ï¼‰ï¼Œä½¿ç”¨ **äº‹ä»¶é˜Ÿåˆ— (Event Queues)** å¹¿æ’­é€šçŸ¥ï¼Œä¾›é€šçŸ¥ã€ç»Ÿè®¡ã€æ’ä»¶ç­‰æ¨¡å—å“åº”ã€‚

3. **å¤æ‚åº¦æ§åˆ¶:**  
   å°†å¤æ‚æ€§é™åˆ¶åœ¨å‰¯ä½œç”¨å¤„ç†å±‚ï¼Œæ ¸å¿ƒä¸»æµç¨‹ä¿æŒå¯æ§ã€æœ‰åºã€å…·å¤‡çŠ¶æ€è·Ÿè¸ªèƒ½åŠ›ã€‚

---

### é˜Ÿåˆ—ç”¨é€”å®šä¹‰

#### âœ… ä»»åŠ¡é˜Ÿåˆ— (Task Queues)

- **ä½œç”¨:** é©±åŠ¨ä¸»æµç¨‹ï¼Œä¼ é€’ä»»åŠ¡æŒ‡ä»¤ã€‚
- **ç‰¹ç‚¹:** é¡ºåºæ€§å¼ºã€è´£ä»»æ˜ç¡®ã€‚
- **ç¤ºä¾‹:**  
  - `ImageDownloadQueue`  
  - `MetadataProcessingQueue`  
  - `AIProcessingQueue`
- **æ¶ˆè´¹è€…:**  
  - download-worker  
  - metadata-worker  
  - ai-worker
- **å…³è”çŠ¶æ€:** æ›´æ–° Task Coordinator DO ä¸­çš„ä»»åŠ¡çŠ¶æ€ã€‚

#### âœ… äº‹ä»¶é˜Ÿåˆ— (Event Queues)

- **ä½œç”¨:** å‘å¸ƒç³»ç»Ÿå†…å·²å‘ç”Ÿçš„é‡è¦äº‹ä»¶ã€‚
- **ç‰¹ç‚¹:** å¹¿æ’­å‹ã€å¯å¤šè®¢é˜…ã€æ— çŠ¶æ€ä¾èµ–ã€‚
- **ç¤ºä¾‹:**  
  - `ImageEventsQueue`  
  - `TaskLifecycleEventsQueue`
- **æ¶ˆè´¹è€…:**  
  - notification-worker  
  - analytics-worker  
  - tag-indexer-worker
- **çŠ¶æ€å…³è”:** ä¸æ›´æ–°ä¸»çŠ¶æ€ï¼Œä»…å¤„ç†å‰¯ä½œç”¨ã€‚

---

### å‘å¸ƒäº‹ä»¶çš„æ—¶æœº (å»ºè®®ç¤ºä¾‹)

| å‘å¸ƒè€… Worker       | è§¦å‘äº‹ä»¶                      | eventType                   |
|---------------------|-------------------------------|-----------------------------|
| download-worker     | å›¾ç‰‡ä¸‹è½½æˆåŠŸ                  | `image.downloaded`          |
| metadata-worker     | å…ƒæ•°æ®æå–æˆåŠŸ                | `image.metadata_extracted`  |
| ai-worker           | AI åˆ†æç»“æœå†™å…¥æˆåŠŸ           | `image.analyzed`            |
| ai-worker / others  | å…¨æµç¨‹æˆåŠŸ                    | `task.completed`            |
| ä»»æ„ Worker         | å¼‚å¸¸å¤±è´¥                      | `task.failed`               |

> âŒ ä¸å†å‘å¸ƒ `image.processed`ï¼Œå› ä¸ºæ¶æ„å·²ç§»é™¤å›¾ç‰‡å˜æ¢åŠŸèƒ½ã€‚

---

### äº‹ä»¶ç»“æ„æ ‡å‡†

æ‰€æœ‰äº‹ä»¶åº”éµå¾ªä»¥ä¸‹ç»“æ„æ¥å£ï¼š

```ts
export interface INEvent<T = Record<string, any>> {
  eventId: string;           // äº‹ä»¶å”¯ä¸€æ ‡è¯† (UUID)
  eventType: string;         // äº‹ä»¶ç±»å‹ (å¦‚ image.downloaded)
  taskId?: string;           // å¯é€‰ï¼Œå…³è”ä»»åŠ¡ ID
  traceId: string;           // è´¯ç©¿è¯·æ±‚å…¨é“¾è·¯çš„è¿½è¸ª ID
  timestamp: number;         // äº‹ä»¶ç”Ÿæˆæ—¶é—´æˆ³ (Unix æ¯«ç§’)
  source: string;            // äº‹ä»¶æ¥æº Worker åç§°
  payload: T;                // äº‹ä»¶å®é™…å†…å®¹
}
