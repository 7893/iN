# .github/workflows/main-ci-cd.yml
# æ›´æ–°æ—¥æœŸ: 2025-05-21
# æ¶æ„ç‰ˆæœ¬: 2025å¹´5æœˆ21æ—¥ (Vercel å‰ç«¯ + Cloudflare è¾¹ç¼˜ + GCPæ ¸å¿ƒåç«¯ + GitHub CI/CD)

name: Main CI/CD Pipeline (Vercel, Cloudflare, GCP)

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev

jobs:
  lint-test-build:
    name: Lint, Test & Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8 # è¯·æ›¿æ¢ä¸ºä½ çš„ pnpm ç‰ˆæœ¬
      - uses: actions/setup-node@v4
        with:
          node-version: '20' # è¯·æ›¿æ¢ä¸ºä½ çš„ Node.js ç‰ˆæœ¬
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint # å‡è®¾ä½ çš„ lint è„šæœ¬æ˜¯ 'pnpm lint'

      - name: Unit Tests
        run: pnpm test # å‡è®¾ä½ çš„å•å…ƒæµ‹è¯•è„šæœ¬æ˜¯ 'pnpm test'

      - name: Build all apps and packages
        run: pnpm build # å‡è®¾ä½ çš„æ„å»ºè„šæœ¬æ˜¯ 'pnpm build' (å¯èƒ½é€šè¿‡ Turborepo)

      - name: Upload build artifacts (optional, if needed by other jobs)
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            apps/**/dist # æ ¹æ®ä½ çš„æ„å»ºè¾“å‡ºè°ƒæ•´è·¯å¾„
            apps/**/.output # Next.js/Nuxt.js on Vercel
            apps/**/.vercel/output # Vercel output
            packages/**/dist

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: lint-test-build # ä¾èµ–ä»£ç æ£€æŸ¥å’Œæ„å»ºï¼ˆå¯é€‰ï¼Œçœ‹æ˜¯å¦éœ€è¦æ„å»ºäº§ç‰©å½±å“IaCï¼‰
    if: github.event_name == 'pull_request' # é€šå¸¸ Plan åªåœ¨ PR æ—¶è¿è¡Œæˆ–éœ€è¦å®¡æŸ¥
    env:
      # Cloudflare Secrets for Terraform Provider
      CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
      # GCP Credentials for Terraform Provider
      GOOGLE_CREDENTIALS: ${{ secrets.GCP_SA_KEY_JSON_TERRAFORM }} # ç”¨äºTerraformçš„GCPæœåŠ¡è´¦å·å¯†é’¥
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        # with:
        #   terraform_version: "1.x.x" # æŒ‡å®šTerraformç‰ˆæœ¬

      - name: Terraform Init
        working-directory: ./infra # å‡è®¾Terraformä»£ç åœ¨ infra ç›®å½•
        run: terraform init -backend-config="bucket=your-tfstate-gcs-bucket-name" # é…ç½®è¿œç¨‹åç«¯

      - name: Terraform Validate
        working-directory: ./infra
        run: terraform validate

      - name: Terraform Plan
        working-directory: ./infra
        id: plan
        run: terraform plan -no-color -out=tfplan
        # continue-on-error: true # å¦‚æœå¸Œæœ›PRä¸­å³ä½¿planæœ‰é”™ä¹Ÿç»§ç»­ï¼Œä»¥ä¾¿çœ‹åˆ°planç»“æœ

      # (å¯é€‰) å¦‚æœå¸Œæœ›å°† plan ç»“æœå‘å¸ƒåˆ° PR è¯„è®º
      # - name: Comment Terraform Plan on PR
      #   uses: actions/github-script@v6
      #   if: github.event_name == 'pull_request'
      #   with:
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     script: |
      #       const output = `#### Terraform Format and Style í ½í¶Œ\`${{ steps.fmt.outcome }}\`
      #       #### Terraform Initialization âš™ï¸\`${{ steps.init.outcome }}\`
      #       #### Terraform Validation í ¾í´–\`${{ steps.validate.outcome }}\`
      #       <details><summary>Validation Output</summary>

      #       \`\`\`diff
      #       ${{ steps.plan.outputs.stdout }}
      #       \`\`\`

      #       </details>

      #       *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Working Directory: \`${{ env.tf_actions_working_dir }}\`, Workflow: \`${{ github.workflow }}\`*`;

      #       github.rest.issues.createComment({
      #         issue_number: context.issue.number,
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         body: output
      #       })

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [lint-test-build, terraform-plan] # ç¡®ä¿Planåœ¨PRä¸­å·²å®¡æŸ¥ï¼ˆå¦‚æœæµç¨‹å¦‚æ­¤è®¾è®¡ï¼‰
    if: (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')) # åˆå¹¶åˆ°mainæˆ–devåˆ†æ”¯æ—¶æ‰§è¡Œ
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
      GOOGLE_CREDENTIALS: ${{ secrets.GCP_SA_KEY_JSON_TERRAFORM }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: ./infra
        run: terraform init -backend-config="bucket=your-tfstate-gcs-bucket-name"

      - name: Terraform Apply
        working-directory: ./infra
        run: terraform apply -auto-approve # æ³¨æ„ï¼šè‡ªåŠ¨æ‰¹å‡†æœ‰é£é™©ï¼Œç¡®ä¿planå·²è¢«å®¡æŸ¥

  deploy-frontend-vercel:
    name: Deploy Frontend to Vercel
    runs-on: ubuntu-latest
    needs: terraform-apply # ä¾èµ–åŸºç¡€è®¾æ–½éƒ¨ç½²å®Œæˆ
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Vercelé€šå¸¸ä¼šè‡ªåŠ¨ä»ä»“åº“æ„å»ºï¼Œä½†å¦‚æœéœ€è¦æ‰‹åŠ¨è§¦å‘æˆ–ä¼ é€’æ„å»ºäº§ç‰©
      # - name: Download build artifacts (if frontend built in previous job)
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: build-artifacts
      #     path: . # ä¸‹è½½åˆ°æ ¹ç›®å½•ï¼Œç„¶åVercel CLIå¯èƒ½éœ€è¦æŒ‡å®šè·¯å¾„

      - name: Deploy to Vercel
        # Vercel GitHub Integration é€šå¸¸ä¼šè‡ªåŠ¨å¤„ç† main/dev åˆ†æ”¯çš„éƒ¨ç½²ã€‚
        # å¦‚æœéœ€è¦æ‰‹åŠ¨æ§åˆ¶æˆ–ä¼ é€’ç‰¹å®šå‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨ Vercel CLIã€‚
        # æ­¤å¤„å‡è®¾ä½¿ç”¨ Vercel çš„ GitHub App è‡ªåŠ¨éƒ¨ç½²ã€‚
        # å¦‚æœæ‰‹åŠ¨ï¼Œç±»ä¼¼ï¼š
        # run: |
        #   npm install -g vercel
        #   vercel pull --yes --environment=${{ github.ref == 'refs/heads/main' && 'production' || 'preview' }} --token=${{ secrets.VERCEL_TOKEN }}
        #   vercel build --token=${{ secrets.VERCEL_TOKEN }} ${{ github.ref == 'refs/heads/main' && '--prod' || '' }}
        #   vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }} ${{ github.ref == 'refs/heads/main' && '--prod' || '' }}
        # working-directory: ./apps/vercel-frontend # å¦‚æœå‰ç«¯åœ¨å­ç›®å½•
        run: echo "Vercel deployment is typically handled by Vercel's GitHub App integration."

  deploy-cloudflare-services:
    name: Deploy Cloudflare Services
    runs-on: ubuntu-latest
    needs: terraform-apply
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')
    env:
      CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
      CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
      # ä½ å¯èƒ½è¿˜éœ€è¦ä¸ºä¸åŒçš„Workerå®šä¹‰ä¸åŒçš„ç¯å¢ƒå˜é‡æˆ–Secrets
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # å‡è®¾ä½ éœ€è¦æ„å»ºWorkers (ä¾‹å¦‚ï¼Œå¦‚æœå®ƒä»¬æ˜¯TypeScript)
      - name: Build Cloudflare Workers/DOs
        run: pnpm turbo run build --filter="./apps/cf-*" # å‡è®¾æ‰€æœ‰Cloudflareåº”ç”¨ä»¥cf-å¼€å¤´

      - name: Deploy API Gateway Worker
        working-directory: ./apps/iN-worker-A-api-gateway-20250521 # æ›¿æ¢ä¸ºä½ çš„Workerè·¯å¾„
        run: npx wrangler deploy wrangler.toml --env ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }} # å‡è®¾wrangler.tomlä¸­å®šä¹‰äº†ç¯å¢ƒ

      - name: Deploy TaskCoordinatorDO
        working-directory: ./apps/iN-do-A-task-coordinator-20250521 # æ›¿æ¢ä¸ºä½ çš„DOè·¯å¾„
        run: npx wrangler deploy wrangler.toml --env ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
      # ä¸ºå…¶ä»– Cloudflare Workers/DOs æ·»åŠ ç±»ä¼¼çš„éƒ¨ç½²æ­¥éª¤

  deploy-gcp-services:
    name: Deploy GCP Services (Functions/Run)
    runs-on: ubuntu-latest
    needs: terraform-apply
    permissions: # For Workload Identity Federation (æ¨è)
      contents: 'read'
      id-token: 'write'
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ä½¿ç”¨ Workload Identity Federation (æ¨è)
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: 'projects/${{ secrets.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ secrets.GCP_WIF_POOL_ID }}/providers/${{ secrets.GCP_WIF_PROVIDER_ID }}'
          service_account: '${{ secrets.GCP_SA_EMAIL_FOR_DEPLOY }}' # ç”¨äºéƒ¨ç½²çš„æœåŠ¡è´¦å·é‚®ç®±

      # æˆ–è€…ä½¿ç”¨æœåŠ¡è´¦å·å¯†é’¥ (ä¸æ¨èç”¨äºç”Ÿäº§ï¼Œä½†ä½œä¸ºå¤‡é€‰)
      # - id: 'auth-key'
      #   name: 'Authenticate to Google Cloud via Key'
      #   uses: 'google-github-actions/auth@v2'
      #   with:
      #     credentials_json: '${{ secrets.GCP_SA_KEY_JSON_DEPLOY }}'


      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      # ç¤ºä¾‹ï¼šéƒ¨ç½²ä¸€ä¸ª GCP Cloud Function
      - name: 'Deploy Download Function'
        run: |-
          cd ./apps/gcp-download-function # å‡è®¾å‡½æ•°ä»£ç åœ¨æ­¤ç›®å½•
          # pnpm install (å¦‚æœæ¯ä¸ªGCP Function/Runæœ‰è‡ªå·±çš„package.json)
          # pnpm build (å¦‚æœéœ€è¦ç¼–è¯‘TSåˆ°JS)
          gcloud functions deploy in-function-download-image \
            --gen2 \
            --runtime nodejs20 \
            --trigger-topic in-pubsub-topic-download-requests \
            --entry-point yourDownloadFunctionEntryPoint \
            --region ${{ secrets.GCP_REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }} \
            --service-account ${{ secrets.GCP_FUNCTION_SA_EMAIL }} \
            --source . # æŒ‡å®šæºä»£ç ç›®å½•
            # --env-vars-file .env.yaml (å¦‚æœä½¿ç”¨envæ–‡ä»¶é…ç½®ç¯å¢ƒå˜é‡)

      # ä¸ºå…¶ä»– GCP Cloud Functions æˆ– Cloud Run æœåŠ¡æ·»åŠ ç±»ä¼¼çš„éƒ¨ç½²æ­¥éª¤
      # éƒ¨ç½² Cloud Run ç¤ºä¾‹:
      # - name: 'Deploy AI Processor Service to Cloud Run'
      #   run: |-
      #     cd ./apps/gcp-ai-processor-service
      #     # gcloud builds submit --tag gcr.io/${{ secrets.GCP_PROJECT_ID }}/in-ai-processor:$GITHUB_SHA (å¦‚æœä½¿ç”¨Cloud Buildæ„å»ºå®¹å™¨)
      #     gcloud run deploy in-service-ai-processor \
      #       --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/in-ai-processor:$GITHUB_SHA \
      #       --platform managed \
      #       --region ${{ secrets.GCP_REGION }} \
      #       --project ${{ secrets.GCP_PROJECT_ID }} \
      #       --service-account ${{ secrets.GCP_RUN_SA_EMAIL }} \
      #       --allow-unauthenticated # (å¦‚æœéœ€è¦å…¬ç½‘è®¿é—®ï¼Œå¦åˆ™é…ç½® Pub/Sub æ¨é€è®¢é˜…çš„è°ƒç”¨è€…æƒé™)
      #       # --set-env-vars=...

  # (å¯é€‰) Post-Deployment Smoke Tests
  # ...

  # (å¯é€‰) Notifications
  # ...
