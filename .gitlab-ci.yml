stages:
  - lint
  - test
  - build
  - deploy

# --------------------------------------------------
# ðŸŒ å…¨å±€é…ç½®
# --------------------------------------------------
default:
  image: node:20
  before_script:
    - corepack enable
    - corepack prepare pnpm@latest --activate
    - pnpm install

# --------------------------------------------------
# ðŸ§¹ Lint
# --------------------------------------------------
lint:
  stage: lint
  script:
    - pnpm lint

# --------------------------------------------------
# ðŸ§ª å•å…ƒæµ‹è¯•
# --------------------------------------------------
unit_tests:
  stage: test
  script:
    - pnpm test

# --------------------------------------------------
# ðŸ” GitleaksÂ æ‰«æ
# --------------------------------------------------
gitleaks_scan:
  stage: test
  image:
    name: zricethezav/gitleaks:latest   # âœ… ç”¨æ˜ å°„å†™æ³•
    entrypoint: [""]                   # âœ… æ”¾åœ¨ image: å†…éƒ¨
  before_script: []                    # ä¸ç»§æ‰¿ Node before_script
  script:
    - gitleaks detect --source=. --verbose --redact \
        --report-format sarif --report-path gitleaks-report.sarif
  artifacts:
    paths:
      - gitleaks-report.sarif
    expire_in: 1 week
  allow_failure: false

# --------------------------------------------------
# ðŸ› ï¸ æž„å»ºå‰ç«¯
# --------------------------------------------------
build_frontend:
  stage: build
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'          # ä»… main åˆ†æ”¯æž„å»º
  script:
    - pnpm build --filter=in-pages               # ç”Ÿæˆ apps/in-pages/dist
  artifacts:
    paths:
      - apps/in-pages/dist
    expire_in: 1 hour

# --------------------------------------------------
# ðŸš€ éƒ¨ç½²åˆ° CloudflareÂ Pages
# --------------------------------------------------
deploy_pages:
  stage: deploy
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'          # ä»… main åˆ†æ”¯éƒ¨ç½²
  needs:
    - job: build_frontend                       # ä¾èµ–æž„å»ºäº§ç‰©
      artifacts: true
  script: >
    pnpm dlx wrangler pages deploy apps/in-pages/dist
    --project-name=in-pages
    --commit-hash=$CI_COMMIT_SHA
    --commit-message="$CI_COMMIT_MESSAGE"
  environment:
    name: production
