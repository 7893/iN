---
stages:
  - lint
  - test
  - build
  - deploy
default:
  image: node:20
  before_script:
    - corepack enable
    - corepack prepare pnpm@latest --activate
    - pnpm install
lint:
  stage: lint
  script:
    - pnpm lint
test:
  stage: test
  script:
    - pnpm test
build:frontend:
  stage: build
  script: >
    echo "Current directory: $(pwd)"

    echo "Listing apps/in-pages directory:"

    ls -la apps/in-pages/

    echo "Content of apps/in-pages/package.json:"

    cat apps/in-pages/package.json

    echo "Checking if pnpm recognizes workspace:"

    # 下面这行复杂的命令现在可以直接写，无需担心 YAML 转义

    pnpm list -r --depth 0 --json | grep '"name": "in-pages"' || echo "Workspace 'in-pages' not found by pnpm list"

    echo "--- End of debug ---"

    pnpm build --filter=in-pages
  artifacts:
    paths:
      - apps/in-pages/dist
    expire_in: 1 hour
deploy:pages:
  stage: deploy
  script:
    - pnpm dlx wrangler pages deploy apps/in-pages/dist --project-name=in-pages
      --commit-dirty=true
  needs:
    - build:frontend
  only:
    - main
  environment:
    name: production

