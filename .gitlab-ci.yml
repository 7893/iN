image: node:22

stages:
  - install
  - lint
  - test

default:
  before_script:
    - corepack enable
    - pnpm install --frozen-lockfile

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .pnpm-store
    - node_modules
    - apps/**/node_modules
    - packages/**/node_modules

install-deps:
  stage: install
  script:
    - echo "‚úÖ Dependencies installed via before_script"
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"

lint:
  stage: lint
  script:
    - pnpm lint
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"

test:
  stage: test
  script:
    - pnpm test
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"

check-gitlab-secrets:
  stage: test
  script:
    - echo "Ì†ΩÌµµÔ∏è Checking GitLab secrets..."
    - echo "Ì†ΩÌ¥ë RUNTIME_HMAC_SECRET length: ${#RUNTIME_HMAC_SECRET}"
    - echo "Ì†ΩÌ¥ë RUNTIME_R2_S3_ACCESS_KEY_ID starts with: ${RUNTIME_R2_S3_ACCESS_KEY_ID:0:4}"
    - echo "Ì†ΩÌ¥ë RUNTIME_R2_S3_ENDPOINT_DEFAULT: $RUNTIME_R2_S3_ENDPOINT_DEFAULT"
    - echo "Ì†ΩÌ¥ë AXIOM_API_TOKEN length: ${#AXIOM_API_TOKEN}"
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"

