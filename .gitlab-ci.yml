stages:
  - lint
  - test
  - build
  - deploy

# --------------------------------------------------
# 🌐 全局配置
# --------------------------------------------------
default:
  image: node:20
  before_script:
    - corepack enable
    - corepack prepare pnpm@latest --activate
    - pnpm install

# --------------------------------------------------
# 🧹 Lint
# --------------------------------------------------
lint:
  stage: lint
  script:
    - pnpm lint

# --------------------------------------------------
# 🧪 单元测试
# --------------------------------------------------
unit_tests:
  stage: test
  script:
    - pnpm test

# --------------------------------------------------
# 🔐 Gitleaks 扫描
# --------------------------------------------------
gitleaks_scan:
  stage: test
  image:
    name: zricethezav/gitleaks:latest   # ✅ 用映射写法
    entrypoint: [""]                   # ✅ 放在 image: 内部
  before_script: []                    # 不继承 Node before_script
  script:
    - gitleaks detect --source=. --verbose --redact \
        --report-format sarif --report-path gitleaks-report.sarif
  artifacts:
    paths:
      - gitleaks-report.sarif
    expire_in: 1 week
  allow_failure: false

# --------------------------------------------------
# 🛠️ 构建前端
# --------------------------------------------------
build_frontend:
  stage: build
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'          # 仅 main 分支构建
  script:
    - pnpm build --filter=in-pages               # 生成 apps/in-pages/dist
  artifacts:
    paths:
      - apps/in-pages/dist
    expire_in: 1 hour

# --------------------------------------------------
# 🚀 部署到 Cloudflare Pages
# --------------------------------------------------
deploy_pages:
  stage: deploy
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'          # 仅 main 分支部署
  needs:
    - job: build_frontend                       # 依赖构建产物
      artifacts: true
  script: >
    pnpm dlx wrangler pages deploy apps/in-pages/dist
    --project-name=in-pages
    --commit-hash=$CI_COMMIT_SHA
    --commit-message="$CI_COMMIT_MESSAGE"
  environment:
    name: production
