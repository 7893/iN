stages:
  - lint
  - test
  - build
  - deploy

default:
  image: node:20
  before_script:
    - corepack enable
    - corepack prepare pnpm@latest --activate
    - pnpm install

lint:
  stage: lint
  script:
    - pnpm lint

test:
  stage: test
  script:
    - pnpm test

build:frontend:
  stage: build
  script:
    - pnpm build --filter=in-pages
  artifacts:
    paths:
      - apps/in-pages/dist
    expire_in: 1h

deploy:pages:
stage: deploy
script:
# 使用 pnpm dlx 执行 wrangler，无需全局安装
# 修正 project-name 为 in-pages
- pnpm dlx wrangler pages deploy apps/in-pages/dist --project-name=in-pages --commit-dirty=true
needs: ["build:frontend"]
only:
- main
environment:
name: production