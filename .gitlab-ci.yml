stages:
  - lint
  - test
  - build
  - deploy

# --------------------------------------------------
# ðŸŒ å…¨å±€è®¾ç½®
# --------------------------------------------------
default:
  image: node:20
  before_script:
    - corepack enable
    - corepack prepare pnpm@latest --activate
    - pnpm install

# --------------------------------------------------
# ðŸ§¹ ä»£ç è´¨é‡
# --------------------------------------------------
lint:
  stage: lint
  script:
    - pnpm lint

# --------------------------------------------------
# ðŸ§ª å•å…ƒæµ‹è¯•
# --------------------------------------------------
unit_tests:
  stage: test
  script:
    - pnpm test

# --------------------------------------------------
# ðŸ” GitleaksÂ å®‰å…¨æ‰«æ
# --------------------------------------------------
gitleaks_scan:
  stage: test
  image: zricethezav/gitleaks:latest
  entrypoint: [""]
  before_script: []          # ä¸ç»§æ‰¿ Node çš„ before_script
  script:
    - gitleaks detect --source=. --report-format sarif \
        --report-path gitleaks-report.sarif --verbose --redact
  artifacts:
    paths:
      - gitleaks-report.sarif
    expire_in: 1 week
  allow_failure: false

# --------------------------------------------------
# ðŸ› ï¸  æž„å»ºå‰ç«¯ (ä»… main åˆ†æ”¯)
# --------------------------------------------------
build_frontend:
  stage: build
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  script:
    - pnpm build --filter=in-pages          # ç”Ÿæˆ apps/in-pages/dist
  artifacts:
    paths:
      - apps/in-pages/dist                  # äº§ç‰©ä¾›éƒ¨ç½²é˜¶æ®µä½¿ç”¨
    expire_in: 1 hour

# --------------------------------------------------
# ðŸš€ éƒ¨ç½²åˆ° CloudflareÂ Pages
# --------------------------------------------------
deploy_pages:
  stage: deploy
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  needs:
    - job: build_frontend                   # ä¾èµ–æž„å»ºäº§ç‰©
      artifacts: true
  script: >
    pnpm dlx wrangler pages deploy apps/in-pages/dist
    --project-name=in-pages
    --commit-hash=$CI_COMMIT_SHA
    --commit-message="$CI_COMMIT_MESSAGE"
  environment:
    name: production
