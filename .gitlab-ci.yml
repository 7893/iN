# ~/iN/.gitlab-ci.yml

stages:
  - install
  - lint
  - test
  - check-secrets

default:
  image: node:22
  before_script:
    - corepack enable
    - pnpm install --frozen-lockfile

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .pnpm-store
    - node_modules/

install-deps:
  stage: install
  script:
    - echo "âœ… ä¾èµ–å®‰è£…å®Œæ¯•"

lint:
  stage: lint
  script:
    - pnpm lint

test:
  stage: test
  script:
    - pnpm test

check-secrets:
  stage: check-secrets
  when: manual
  script:
    - echo "ğŸ” æ£€æŸ¥ .env.secrets ä¸­æ˜¯å¦åŒ…å«å ä½ç¬¦..."
    - |
      if grep -E '(<placeholder>|xxx|optional_|generate_)' .env.secrets; then
        echo "âŒ æ£€æµ‹åˆ°æœªæ›¿æ¢çš„å ä½ç¬¦ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥ .env.secrets ä¸­çš„å€¼æ˜¯å¦å®Œæ•´ï¼"
        exit 1
      else
        echo "âœ… æœªå‘ç°å ä½ç¬¦ï¼Œsecrets æ£€æŸ¥é€šè¿‡ã€‚"
      fi
