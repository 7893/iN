stages:
  - lint
  - test
  - build
  - deploy

# --------------------------------------------------
# 🌐 全局设置
# --------------------------------------------------
default:
  image: node:20
  before_script:
    - corepack enable
    - corepack prepare pnpm@latest --activate
    - pnpm install

# --------------------------------------------------
# 🧹 代码质量
# --------------------------------------------------
lint:
  stage: lint
  script:
    - pnpm lint

# --------------------------------------------------
# 🧪 单元测试
# --------------------------------------------------
unit_tests:
  stage: test
  script:
    - pnpm test

# --------------------------------------------------
# 🔐 Gitleaks 安全扫描
# --------------------------------------------------
gitleaks_scan:
  stage: test
  image: zricethezav/gitleaks:latest
  entrypoint: [""]
  before_script: []          # 不继承 Node 的 before_script
  script:
    - gitleaks detect --source=. --report-format sarif \
        --report-path gitleaks-report.sarif --verbose --redact
  artifacts:
    paths:
      - gitleaks-report.sarif
    expire_in: 1 week
  allow_failure: false

# --------------------------------------------------
# 🛠️  构建前端 (仅 main 分支)
# --------------------------------------------------
build_frontend:
  stage: build
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  script:
    - pnpm build --filter=in-pages          # 生成 apps/in-pages/dist
  artifacts:
    paths:
      - apps/in-pages/dist                  # 产物供部署阶段使用
    expire_in: 1 hour

# --------------------------------------------------
# 🚀 部署到 Cloudflare Pages
# --------------------------------------------------
deploy_pages:
  stage: deploy
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  needs:
    - job: build_frontend                   # 依赖构建产物
      artifacts: true
  script: >
    pnpm dlx wrangler pages deploy apps/in-pages/dist
    --project-name=in-pages
    --commit-hash=$CI_COMMIT_SHA
    --commit-message="$CI_COMMIT_MESSAGE"
  environment:
    name: production
